{% extends 'base.html' %}

{% block title %}Edit QR Code - {{ qr_code.name }} - QR Craft{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
/* Formal UI styles with professional appearance - matching create_qr.html */
    body {
        background-color: #f7f7f7;
    }
    
    .formal-card {
        background: white;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .formal-button {
        background-color: #2c5282;
        color: white;
        border: none;
        transition: background-color 0.2s ease;
    }
    
    .formal-button:hover {
        background-color: #2a4e7c;
    }
    
    .formal-button-secondary {
        background-color: #718096;
        color: white;
        border: none;
        transition: background-color 0.2s ease;
    }
    
    .formal-button-secondary:hover {
        background-color: #4a5568;
    }
    
    .section-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a202c;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }
    
    .form-input {
        border: 1px solid #cbd5e0;
        background-color: #ffffff;
        font-size: 0.875rem;
        padding: 0.625rem 0.875rem;
        transition: border-color 0.15s ease;
    }
    
    .form-input:focus {
        border-color: #2c5282;
        outline: none;
        box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
    }
    
    .qr-type-option {
        background: white;
        border: 2px solid #e2e8f0;
        transition: all 0.15s ease;
        cursor: pointer;
    }
    
    .qr-type-option:hover {
        border-color: #cbd5e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .qr-type-option.active {
        border-color: #2c5282;
        background-color: #f7fafc;
    }
    
    .tab-button {
        font-size: 0.875rem;
        font-weight: 500;
        color: #718096;
        padding: 0.75rem 1rem;
        border-bottom: 3px solid transparent;
        transition: all 0.15s ease;
    }
    
    .tab-button.active {
        color: #2c5282;
        border-bottom-color: #2c5282;
    }
    
    .template-card {
        border: 2px solid #e2e8f0;
        transition: all 0.15s ease;
        cursor: pointer;
        background: white;
    }
    
    .template-card:hover {
        border-color: #cbd5e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .template-card.selected {
        border-color: #2c5282;
        background-color: #f7fafc;
    }
    
    /* Color preview with formal styling */
    .color-preview {
        width: 28px;
        height: 28px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: box-shadow 0.15s ease;
    }
    
    .color-preview:hover {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Professional accordion styling */
    .accordion-header {
        background-color: #f8f9fa;
        border: 1px solid #e2e8f0;
        font-weight: 500;
        color: #2d3748;
        transition: background-color 0.15s ease;
    }
    
    .accordion-header:hover {
        background-color: #f1f3f5;
    }
    
    /* Formal shape options */
    .shape-option label {
        border: 2px solid #e2e8f0;
        background: white;
        transition: all 0.15s ease;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .shape-option input:checked + label {
        border-color: #2c5282;
        background-color: #f7fafc;
        box-shadow: none;
        transform: none;
    }
    
    .shape-option label:hover {
        border-color: #cbd5e0;
        transform: none;
        box-shadow: none;
    }
    
    /* Professional range slider */
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #2c5282;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
        background: #2a4e7c;
        transform: none;
    }
    
    /* Current QR display styling */
    .current-qr-display {
        border: 2px solid #e2e8f0;
        background: #fafafa;
        padding: 1.5rem;
        border-radius: 8px;
    }
    
    /* Analytics styling */
    .analytics-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .analytics-number {
        font-size: 2rem;
        font-weight: bold;
        color: white;
    }
    
    /* Scan history styling */
    .scan-item {
        border-left: 3px solid #2c5282;
        background: #f7fafc;
        transition: background-color 0.15s ease;
    }
    
    .scan-item:hover {
        background: #edf2f7;
    }
    
    /* Professional color picker popup */
    .color-picker-popup {
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        background: white;
        border-radius: 4px;
    }
    
    .color-preset {
        border: 1px solid #e2e8f0;
        transition: transform 0.1s ease;
    }
    
    .color-preset:hover {
        transform: scale(1.05);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Badge styling */
    .badge {
        background-color: #edf2f7;
        color: #4a5568;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 3px;
    }
    
    .badge.success {
        background-color: #c6f6d5;
        color: #22543d;
    }
    
    .badge.primary {
        background-color: #e6f2ff;
        color: #2c5282;
    }
    
    .badge.warning {
        background-color: #fefcbf;
        color: #744210;
    }
    
    /* Help text styling */
    .help-text {
        font-size: 0.8125rem;
        color: #718096;
    }
    
    /* Status indicators */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-active {
        background-color: #48bb78;
    }
    
    .status-inactive {
        background-color: #ed8936;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Professional Page Header -->
    <div class="mb-8 border-b border-gray-300 pb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Edit QR Code</h1>
                <p class="text-gray-600 mt-2">
                    Modify "{{ qr_code.name }}" - {{ qr_code.qr_type|title }} QR Code
                    <span class="ml-2">
                        <span class="status-indicator status-active"></span>
                        <span class="badge success">Active</span>
                    </span>
                </p>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('view_qr', qr_id=qr_code.unique_id) }}" 
                   class="formal-button-secondary py-2 px-4 font-medium inline-flex items-center">
                    <i class="fas fa-eye mr-2"></i> View QR
                </a>
                <a href="{{ url_for('dashboard') }}" 
                   class="formal-button-secondary py-2 px-4 font-medium inline-flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <!-- Flash Messages with formal styling -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-6 p-4 formal-card {% if category == 'success' %}bg-green-50 border-green-200{% elif category == 'danger' or category == 'error' %}bg-red-50 border-red-200{% elif category == 'warning' %}bg-yellow-50 border-yellow-200{% elif category == 'info' %}bg-blue-50 border-blue-200{% endif %}" role="alert">
                    <div class="flex items-center">
                        {% if category == 'success' %}
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        {% elif category == 'danger' or category == 'error' %}
                            <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                        {% elif category == 'info' %}
                            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                        {% endif %}
                        <div class="flex-1">{{ message }}</div>
                        <button type="button" class="ml-4 text-gray-500 hover:text-gray-700" data-bs-dismiss="alert" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <form id="edit-qr-form" action="/qr/{{ qr_code.unique_id }}/edit" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <div class="xl:col-span-3">
                <!-- Current QR Code Status -->
                <div class="formal-card p-6 mb-6">
                    <h2 class="section-header">
                        <span class="mr-2 text-gray-500"><i class="fas fa-info-circle"></i></span>
                        Current QR Code Status
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="current-qr-display text-center">
                            {% if qr_image %}
                                <img src="data:image/png;base64,{{ qr_image }}" alt="Current QR Code" class="w-full h-auto max-w-48 mx-auto mb-4">
                            {% else %}
                                <div class="w-48 h-48 mx-auto mb-4 bg-gray-200 flex items-center justify-center">
                                    <i class="fas fa-qrcode text-4xl text-gray-400"></i>
                                </div>
                            {% endif %}
                            <p class="text-sm text-gray-600">Current Version</p>
                        </div>
                        
                        <div class="analytics-card p-6 text-center">
                            <div class="analytics-number">{{ scans|length if scans else 0 }}</div>
                            <p class="text-sm opacity-90">Total Scans</p>
                            <div class="mt-2 text-xs opacity-75">
                                {% if scans and scans|length > 0 %}
                                    Last scan: {{ scans[0].timestamp.strftime('%m/%d/%Y') }}
                                {% else %}
                                    No scans yet
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Type:</span>
                                <span class="badge primary">{{ qr_code.qr_type|title }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Created:</span>
                                <span class="text-sm text-gray-800">{{ qr_code.created_at.strftime('%m/%d/%Y') }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Last Updated:</span>
                                <span class="text-sm text-gray-800">
                                    {% if qr_code.updated_at %}
                                        {{ qr_code.updated_at.strftime('%m/%d/%Y') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Template:</span>
                                <span class="text-sm text-gray-800">{{ qr_code.template|title if qr_code.template else 'Custom' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: QR Type (Read-only display) -->
                <div class="formal-card p-6 mb-6">
                    <h2 class="section-header">
                        <span class="mr-2 text-gray-500">1.</span>
                        QR Code Type
                        <span class="ml-2 badge">Current: {{ qr_code.qr_type|title }}</span>
                    </h2>
                    
                    <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" role="radiogroup" aria-label="QR code type options">
                        <!-- QR Type Options - with current type highlighted -->
                        {% set qr_types = [
                            ('link', 'fas fa-link', 'URL'),
                            ('email', 'fas fa-envelope', 'Email'),
                            ('text', 'fas fa-font', 'Text'),
                            ('call', 'fas fa-phone', 'Call'),
                            ('sms', 'fas fa-sms', 'SMS'),
                            ('whatsapp', 'fab fa-whatsapp', 'WhatsApp'),
                            ('wifi', 'fas fa-wifi', 'WiFi'),
                            ('vcard', 'fas fa-address-card', 'vCard'),
                            ('event', 'fas fa-calendar-alt', 'Event')
                        ] %}
                        
                        {% for type_val, icon, label in qr_types %}
                            <div class="qr-type-option p-4 text-center {{ 'active' if qr_code.qr_type == type_val else '' }}" 
                                 data-type="{{ type_val }}" tabindex="0" role="radio" 
                                 aria-checked="{{ 'true' if qr_code.qr_type == type_val else 'false' }}">
                                <i class="{{ icon }} {{ 'text-blue-700' if qr_code.qr_type == type_val else 'text-gray-600' }} text-xl mb-2"></i>
                                <div class="text-sm font-medium text-gray-700">{{ label }}</div>
                                <input type="radio" name="qr_type" value="{{ type_val }}" 
                                       {{ 'checked' if qr_code.qr_type == type_val else '' }} class="hidden">
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Step 2: QR Content Settings -->
                <div class="formal-card p-6 mb-6">
                    <h2 class="section-header">
                        <span class="mr-2 text-gray-500">2.</span>
                        Update QR Code Content
                    </h2>
                    
                    <div class="mb-6">
                        <label for="name" class="form-label block">QR Code Name <span class="text-red-500">*</span></label>
                        <input type="text" class="form-input w-full" id="name" name="name" 
                               value="{{ qr_code.name }}" placeholder="Enter a name for your QR code" required>
                        <p class="help-text mt-1">This name is for your reference only</p>
                    </div>
                    
                    <!-- Content Fields for Different QR Types -->
                    <div id="qr-content-fields">
                        <!-- URL Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'link' else '' }}" id="link-content">
                            <div class="mb-6">
                                <label for="url" class="form-label block">Website URL <span class="text-red-500">*</span></label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-globe"></i>
                                    </span>
                                    <input type="url" class="form-input flex-1" id="url" name="url" 
                                           value="{{ qr_code.link_detail.url if qr_code.link_detail else '' }}" 
                                           placeholder="https://example.com" required>
                                </div>
                                <p class="help-text mt-1">Enter the full URL including https://</p>
                            </div>
                        </div>
                        
                        <!-- Email Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'email' else '' }}" id="email-content">
                            <div class="mb-6">
                                <label for="email" class="form-label block">Email Address <span class="text-red-500">*</span></label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-at"></i>
                                    </span>
                                    <input type="email" class="form-input flex-1" id="email" name="email" 
                                           value="{{ qr_code.email_detail.email if qr_code.email_detail else '' }}" 
                                           placeholder="recipient@example.com" required>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="subject" class="form-label block">Subject</label>
                                <input type="text" class="form-input w-full" id="subject" name="subject" 
                                       value="{{ qr_code.email_detail.subject if qr_code.email_detail else '' }}" 
                                       placeholder="Email subject">
                            </div>
                            <div class="mb-6">
                                <label for="body" class="form-label block">Message</label>
                                <textarea class="form-input w-full" id="body" name="body" rows="3" 
                                          placeholder="Email message content">{{ qr_code.email_detail.body if qr_code.email_detail else '' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- Text Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'text' else '' }}" id="text-content">
                            <div class="mb-6">
                                <label for="text" class="form-label block">Text Content <span class="text-red-500">*</span></label>
                                <textarea class="form-input w-full" id="text" name="text" rows="5" 
                                          placeholder="Enter your text message" required>{{ qr_code.text_detail.text if qr_code.text_detail else '' }}</textarea>
                                <p class="help-text mt-1">
                                    <span id="textCounter">{{ qr_code.text_detail.text|length if qr_code.text_detail and qr_code.text_detail.text else 0 }}</span>/500 characters
                                </p>
                            </div>
                        </div>
                        
                        <!-- Phone Call Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'call' else '' }}" id="call-content">
                            <div class="mb-6">
                                <label for="phone" class="form-label block">Phone Number <span class="text-red-500">*</span></label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                    <input type="tel" class="form-input flex-1" id="phone" name="phone" 
                                           value="{{ qr_code.phone_detail.phone if qr_code.phone_detail else '' }}" 
                                           placeholder="+1234567890" required>
                                </div>
                                <p class="help-text mt-1">Include country code (e.g., +1 for US)</p>
                            </div>
                        </div>
                        
                        <!-- SMS Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'sms' else '' }}" id="sms-content">
                            <div class="mb-6">
                                <label for="sms-phone" class="form-label block">Phone Number <span class="text-red-500">*</span></label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-mobile-alt"></i>
                                    </span>
                                    <input type="tel" class="form-input flex-1" id="sms-phone" name="phone" 
                                           value="{{ qr_code.sms_detail.phone if qr_code.sms_detail else '' }}" 
                                           placeholder="+1234567890" required>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="message" class="form-label block">Message</label>
                                <textarea class="form-input w-full" id="message" name="message" rows="3" 
                                          placeholder="SMS message content">{{ qr_code.sms_detail.message if qr_code.sms_detail else '' }}</textarea>
                                <p class="help-text mt-1">
                                    <span id="smsCounter">{{ qr_code.sms_detail.message|length if qr_code.sms_detail and qr_code.sms_detail.message else 0 }}</span>/160 characters
                                </p>
                            </div>
                        </div>
                        
                        <!-- WhatsApp Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'whatsapp' else '' }}" id="whatsapp-content">
                            <div class="mb-6">
                                <label for="whatsapp-phone" class="form-label block">Phone Number <span class="text-red-500">*</span></label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fab fa-whatsapp"></i>
                                    </span>
                                    <input type="tel" class="form-input flex-1" id="whatsapp-phone" name="phone" 
                                           value="{{ qr_code.whatsapp_detail.phone if qr_code.whatsapp_detail else '' }}" 
                                           placeholder="+1234567890" required>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="whatsapp-message" class="form-label block">Message</label>
                                <textarea class="form-input w-full" id="whatsapp-message" name="message" rows="3" 
                                          placeholder="WhatsApp message content">{{ qr_code.whatsapp_detail.message if qr_code.whatsapp_detail else '' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- WiFi Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'wifi' else '' }}" id="wifi-content">
                            <div class="mb-6">
                                <label for="ssid" class="form-label block">Network Name (SSID) <span class="text-red-500">*</span></label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-wifi"></i>
                                    </span>
                                    <input type="text" class="form-input flex-1" id="ssid" name="ssid" 
                                           value="{{ qr_code.wifi_detail.ssid if qr_code.wifi_detail else '' }}" 
                                           placeholder="Your WiFi network name" required>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="wifi-password" class="form-label block">Password</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-key"></i>
                                    </span>
                                    <input type="text" class="form-input flex-1" id="wifi-password" name="password" 
                                           value="{{ qr_code.wifi_detail.password if qr_code.wifi_detail else '' }}" 
                                           placeholder="WiFi password">
                                    <span class="inline-flex items-center px-3 border border-l-0 border-gray-300 bg-gray-50 text-gray-500 cursor-pointer" id="toggleWifiPassword">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="encryption" class="form-label block">Security Type</label>
                                <select class="form-input w-full" id="encryption" name="encryption">
                                    <option value="WPA" {{ 'selected' if qr_code.wifi_detail and qr_code.wifi_detail.encryption == 'WPA' else '' }}>WPA/WPA2/WPA3</option>
                                    <option value="WEP" {{ 'selected' if qr_code.wifi_detail and qr_code.wifi_detail.encryption == 'WEP' else '' }}>WEP</option>
                                    <option value="nopass" {{ 'selected' if qr_code.wifi_detail and qr_code.wifi_detail.encryption == 'nopass' else '' }}>No Password</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- vCard Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'vcard' else '' }}" id="vcard-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="full_name" class="form-label block">Full Name <span class="text-red-500">*</span></label>
                                    <input type="text" class="form-input w-full" id="full_name" name="full_name" 
                                           value="{{ qr_code.vcard_detail.name if qr_code.vcard_detail else '' }}" 
                                           placeholder="John Doe" required>
                                </div>
                                <div>
                                    <label for="vcard-phone" class="form-label block">Phone Number</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                        <input type="tel" class="form-input flex-1" id="vcard-phone" name="vcard-phone" 
                                               value="{{ qr_code.vcard_detail.phone if qr_code.vcard_detail else '' }}" 
                                               placeholder="+1234567890">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="vcard-email" class="form-label block">Email</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-at"></i>
                                    </span>
                                    <input type="email" class="form-input flex-1" id="vcard-email" name="vcard-email" 
                                           value="{{ qr_code.vcard_detail.email if qr_code.vcard_detail else '' }}" 
                                           placeholder="contact@example.com">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="company" class="form-label block">Company</label>
                                    <input type="text" class="form-input w-full" id="company" name="company" 
                                           value="{{ qr_code.vcard_detail.company if qr_code.vcard_detail else '' }}" 
                                           placeholder="Company name">
                                </div>
                                <div>
                                    <label for="title" class="form-label block">Job Title</label>
                                    <input type="text" class="form-input w-full" id="title" name="title" 
                                           value="{{ qr_code.vcard_detail.title if qr_code.vcard_detail else '' }}" 
                                           placeholder="Job title">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="address" class="form-label block">Address</label>
                                <textarea class="form-input w-full" id="address" name="address" rows="2" 
                                          placeholder="Street address">{{ qr_code.vcard_detail.address if qr_code.vcard_detail else '' }}</textarea>
                            </div>
                            <div class="mb-6">
                                <label for="website" class="form-label block">Website</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-globe"></i>
                                    </span>
                                    <input type="url" class="form-input flex-1" id="website" name="website" 
                                           value="{{ qr_code.vcard_detail.website if qr_code.vcard_detail else '' }}" 
                                           placeholder="https://example.com">
                                </div>
                            </div>
                            
                            <!-- Social Media Links for vCard -->
                            <div class="mb-6">
                                <label class="form-label block mb-4">Social Media Links</label>
                                {% set social_data = qr_code.vcard_detail.social_media|from_json if qr_code.vcard_detail and qr_code.vcard_detail.social_media else {} %}
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <i class="fab fa-linkedin text-blue-700 w-5"></i>
                                        <input type="url" name="social_linkedin" 
                                               value="{{ social_data.linkedin if social_data.linkedin else '' }}"
                                               placeholder="https://linkedin.com/in/yourprofile" class="form-input flex-1">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <i class="fab fa-twitter text-blue-400 w-5"></i>
                                        <input type="url" name="social_twitter" 
                                               value="{{ social_data.twitter if social_data.twitter else '' }}"
                                               placeholder="https://twitter.com/yourprofile" class="form-input flex-1">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <i class="fab fa-facebook text-blue-600 w-5"></i>
                                        <input type="url" name="social_facebook" 
                                               value="{{ social_data.facebook if social_data.facebook else '' }}"
                                               placeholder="https://facebook.com/yourprofile" class="form-input flex-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Event Content Fields -->
                        <div class="qr-type-content {{ 'hidden' if qr_code.qr_type != 'event' else '' }}" id="event-content">
                            <div class="mb-6">
                                <label for="event-title" class="form-label block">Event Title <span class="text-red-500">*</span></label>
                                <input type="text" class="form-input w-full" id="event-title" name="event-title" 
                                       value="{{ qr_code.event_detail.title if qr_code.event_detail else '' }}" 
                                       placeholder="Event name" required>
                            </div>
                            <div class="mb-6">
                                <label for="location" class="form-label block">Location</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </span>
                                    <input type="text" class="form-input flex-1" id="location" name="location" 
                                           value="{{ qr_code.event_detail.location if qr_code.event_detail else '' }}" 
                                           placeholder="Event location">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="start_date" class="form-label block">Start Date/Time <span class="text-red-500">*</span></label>
                                    <input type="datetime-local" class="form-input w-full" id="start_date" name="start_date" 
                                           value="{{ qr_code.event_detail.start_date.strftime('%Y-%m-%dT%H:%M') if qr_code.event_detail and qr_code.event_detail.start_date else '' }}" 
                                           required>
                                </div>
                                <div>
                                    <label for="end_time" class="form-label block">End Date/Time</label>
                                    <input type="datetime-local" class="form-input w-full" id="end_time" name="end_time" 
                                           value="{{ qr_code.event_detail.end_time.strftime('%Y-%m-%dT%H:%M') if qr_code.event_detail and qr_code.event_detail.end_time else '' }}">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="description" class="form-label block">Description</label>
                                <textarea class="form-input w-full" id="description" name="description" rows="3" 
                                          placeholder="Event description">{{ qr_code.event_detail.description if qr_code.event_detail else '' }}</textarea>
                            </div>
                            <div class="mb-6">
                                <label for="organizer" class="form-label block">Organizer</label>
                                <input type="text" class="form-input w-full" id="organizer" name="organizer" 
                                       value="{{ qr_code.event_detail.organizer if qr_code.event_detail else '' }}" 
                                       placeholder="Event organizer">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: QR Code Styling -->
                <div class="formal-card p-6 mb-6">
                    <h2 class="section-header">
                        <span class="mr-2 text-gray-500">3.</span>
                        Update QR Code Design
                    </h2>
                    
                    <div class="mb-8">
                        <nav class="flex border-b border-gray-200" id="qrDesignTab" role="tablist">
                            <button class="tab-button active" id="templates-tab" data-bs-toggle="pill" data-bs-target="#templates" type="button" role="tab" aria-controls="templates" aria-selected="true">
                                Templates
                            </button>
                            <button class="tab-button" id="custom-tab" data-bs-toggle="pill" data-bs-target="#custom" type="button" role="tab" aria-controls="custom" aria-selected="false">
                                Custom Design
                            </button>
                            <button class="tab-button" id="advanced-tab" data-bs-toggle="pill" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">
                                Advanced
                            </button>
                        </nav>
                    </div>
                    
                    <div class="tab-content" id="qrDesignTabContent">
                        <!-- Templates Tab -->
                        <div class="tab-pane fade show active" id="templates" role="tabpanel" aria-labelledby="templates-tab">
                            <div class="template-selector">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {% set templates = [
                                        ('modern', 'Modern', 'Clean and professional'),
                                        ('corporate', 'Corporate', 'Formal and elegant'),
                                        ('playful', 'Playful', 'Vibrant and fun'),
                                        ('minimal', 'Minimal', 'Simple and clean'),
                                        ('high_contrast', 'High Contrast', 'Maximum readability'),
                                        ('', 'Custom', 'Create your own style')
                                    ] %}
                                    
                                    {% for template_val, template_name, template_desc in templates %}
                                        <div>
                                            <div class="template-card p-6 cursor-pointer {{ 'selected' if qr_code.template == template_val else '' }}" 
                                                 data-template="{{ template_val }}" tabindex="0" role="button" 
                                                 aria-pressed="{{ 'true' if qr_code.template == template_val else 'false' }}">
                                                <div class="template-preview bg-gray-50 p-5 text-center mb-4">
                                                    {% if template_val == 'playful' %}
                                                        <i class="fas fa-qrcode text-4xl" style="background: linear-gradient(135deg, #FF5500, #FFAA00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                                                    {% elif template_val == '' %}
                                                        <i class="fas fa-palette text-gray-500 text-4xl"></i>
                                                    {% else %}
                                                        <i class="fas fa-qrcode text-blue-700 text-4xl"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="font-semibold text-gray-800">{{ template_name }}</h3>
                                                    <p class="text-sm text-gray-600 mt-1">{{ template_desc }}</p>
                                                    <input type="radio" name="template" value="{{ template_val }}" 
                                                           {{ 'checked' if qr_code.template == template_val else '' }} class="hidden">
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Design Tab -->
                        <div class="tab-pane fade hidden" id="custom" role="tabpanel" aria-labelledby="custom-tab">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="form-label block mb-3">QR Code Shape</label>
                                    <div class="flex flex-wrap gap-2">
                                        {% set shapes = [
                                            ('square', 'fas fa-square', 'Square'),
                                            ('rounded', 'fas fa-square', 'Rounded'),
                                            ('circle', 'fas fa-circle', 'Circle'),
                                            ('vertical_bars', 'fas fa-grip-lines', 'Vertical'),
                                            ('horizontal_bars', 'fas fa-grip-lines-vertical', 'Horizontal'),
                                            ('gapped_square', 'fas fa-th-large', 'Gapped')
                                        ] %}
                                        
                                        {% for shape_val, icon, label in shapes %}
                                            <div class="shape-option">
                                                <input type="radio" id="shape-{{ shape_val }}" name="shape" value="{{ shape_val }}" 
                                                       {{ 'checked' if qr_code.shape == shape_val else 'checked' if loop.first and not qr_code.shape else '' }} class="hidden">
                                                <label for="shape-{{ shape_val }}" class="inline-flex items-center gap-2 cursor-pointer" tabindex="0">
                                                    <i class="{{ icon }} text-blue-700"></i>
                                                    <span class="text-sm font-medium text-gray-700">{{ label }}</span>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="form-label block mb-3">Frame Style (Optional)</label>
                                    <div class="flex flex-wrap gap-2">
                                        {% set frames = [
                                            ('', 'fas fa-ban', 'None'),
                                            ('square', 'far fa-square', 'Square'),
                                            ('scan_me', 'fas fa-mobile-alt', 'Scan Me'),
                                            ('branded', 'fas fa-building', 'Branded'),
                                            ('circle', 'far fa-circle', 'Circle')
                                        ] %}
                                        
                                        {% for frame_val, icon, label in frames %}
                                            <div class="shape-option">
                                                <input type="radio" id="frame-{{ frame_val if frame_val else 'none' }}" name="frame_type" value="{{ frame_val }}" 
                                                       {{ 'checked' if qr_code.frame_type == frame_val else 'checked' if loop.first and not qr_code.frame_type else '' }} class="hidden">
                                                <label for="frame-{{ frame_val if frame_val else 'none' }}" class="inline-flex items-center gap-2 cursor-pointer" tabindex="0">
                                                    <i class="{{ icon }} text-gray-600"></i>
                                                    <span class="text-sm font-medium text-gray-700">{{ label }}</span>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div id="frame-text-container" class="mt-4 {{ 'hidden' if not qr_code.frame_type or qr_code.frame_type not in ['scan_me', 'branded'] else '' }}">
                                        <label for="frame_text" class="form-label block">Frame Text</label>
                                        <input type="text" class="form-input w-full" id="frame_text" name="frame_text" 
                                               value="{{ qr_code.frame_text if qr_code.frame_text else 'SCAN ME' }}" placeholder="SCAN ME">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="color" class="form-label block">QR Code Color</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50">
                                            <div id="color-preview" class="color-preview" 
                                                 style="background-color: {{ qr_code.color if qr_code.color else '#000000' }};" 
                                                 tabindex="0" role="button" aria-label="Pick QR code color"></div>
                                        </span>
                                        <input type="text" class="form-input flex-1" id="color" name="color" 
                                               value="{{ qr_code.color if qr_code.color else '#000000' }}">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="background_color" class="form-label block">Background Color</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50">
                                            <div id="bg-color-preview" class="color-preview" 
                                                 style="background-color: {{ qr_code.background_color if qr_code.background_color else '#FFFFFF' }};" 
                                                 tabindex="0" role="button" aria-label="Pick background color"></div>
                                        </span>
                                        <input type="text" class="form-input flex-1" id="background_color" name="background_color" 
                                               value="{{ qr_code.background_color if qr_code.background_color else '#FFFFFF' }}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label for="logo" class="form-label block">Update Logo (Optional)</label>
                                {% if qr_code.logo_path %}
                                    <div class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-image text-blue-600 mr-2"></i>
                                                <span class="text-sm text-blue-800">Current logo: {{ qr_code.logo_path.split('/')[-1] }}</span>
                                            </div>
                                            <button type="button" id="removeCurrentLogo" class="text-red-600 hover:text-red-800 text-sm">
                                                <i class="fas fa-times mr-1"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="flex">
                                    <input type="file" class="form-input flex-1" id="logo" name="logo" accept="image/*">
                                    <button class="inline-flex items-center px-3 border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100" type="button" id="removeLogo">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <p class="help-text mt-1">Upload a new logo to replace the current one</p>
                                
                                <div class="mt-4">
                                    <div class="flex items-center">
                                        <input class="h-4 w-4 text-blue-700 focus:ring-blue-500 mr-3" type="checkbox" id="round_logo" name="round_logo" value="true" 
                                               {{ 'checked' if qr_code.round_logo else '' }}>
                                        <label class="text-gray-700" for="round_logo">Apply rounded corners to logo</label>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <label for="logo_size_percentage" class="form-label block">
                                        Logo Size: <span id="logo-size-value" class="font-semibold">{{ qr_code.logo_size_percentage if qr_code.logo_size_percentage else 25 }}</span>%
                                    </label>
                                    <input type="range" class="w-full" id="logo_size_percentage" name="logo_size_percentage" min="10" max="30" 
                                           value="{{ qr_code.logo_size_percentage if qr_code.logo_size_percentage else 25 }}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Tab -->
                        <div class="tab-pane fade hidden" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
                            <div class="space-y-4">
                                <!-- Eye Customization -->
                                <div class="accordion-header p-4 flex items-center justify-between cursor-pointer" x-data="{open: {{ 'true' if qr_code.custom_eyes else 'false' }}}" @click="open = !open">
                                    <h3 class="text-sm font-medium text-gray-700 flex items-center">
                                        <i class="fas fa-eye text-gray-600 mr-2"></i> Eye Customization
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 text-sm transition-transform duration-200" :class="{'transform rotate-180': open}"></i>
                                </div>
                                <div x-show="open" x-transition class="p-4 border border-t-0 border-gray-200">
                                    <div class="mb-4">
                                        <div class="flex items-center">
                                            <input class="h-4 w-4 text-blue-700 focus:ring-blue-500 mr-3" type="checkbox" id="custom_eyes" name="custom_eyes" value="true" 
                                                   {{ 'checked' if qr_code.custom_eyes else '' }}>
                                            <label class="text-gray-700" for="custom_eyes">Customize QR code eyes</label>
                                        </div>
                                    </div>
                                    
                                    <div id="eye-customization-options" class="{{ 'hidden' if not qr_code.custom_eyes else '' }}">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="inner_eye_style" class="form-label block">Inner Eye Style</label>
                                                <select class="form-input w-full" id="inner_eye_style" name="inner_eye_style">
                                                    <option value="square" {{ 'selected' if qr_code.inner_eye_style == 'square' else '' }}>Square</option>
                                                    <option value="circle" {{ 'selected' if qr_code.inner_eye_style == 'circle' else 'selected' if not qr_code.inner_eye_style else '' }}>Circle</option>
                                                    <option value="rounded" {{ 'selected' if qr_code.inner_eye_style == 'rounded' else '' }}>Rounded</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label for="outer_eye_style" class="form-label block">Outer Eye Style</label>
                                                <select class="form-input w-full" id="outer_eye_style" name="outer_eye_style">
                                                    <option value="square" {{ 'selected' if qr_code.outer_eye_style == 'square' else '' }}>Square</option>
                                                    <option value="circle" {{ 'selected' if qr_code.outer_eye_style == 'circle' else '' }}>Circle</option>
                                                    <option value="rounded" {{ 'selected' if qr_code.outer_eye_style == 'rounded' else 'selected' if not qr_code.outer_eye_style else '' }}>Rounded</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label for="inner_eye_color" class="form-label block">Inner Eye Color</label>
                                                <div class="flex">
                                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50">
                                                        <div id="inner-eye-color-preview" class="color-preview" 
                                                             style="background-color: {{ qr_code.inner_eye_color if qr_code.inner_eye_color else qr_code.color if qr_code.color else '#000000' }};" 
                                                             tabindex="0" role="button"></div>
                                                    </span>
                                                    <input type="text" class="form-input flex-1" id="inner_eye_color" name="inner_eye_color" 
                                                           value="{{ qr_code.inner_eye_color if qr_code.inner_eye_color else qr_code.color if qr_code.color else '#000000' }}">
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label for="outer_eye_color" class="form-label block">Outer Eye Color</label>
                                                <div class="flex">
                                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50">
                                                        <div id="outer-eye-color-preview" class="color-preview" 
                                                             style="background-color: {{ qr_code.outer_eye_color if qr_code.outer_eye_color else qr_code.color if qr_code.color else '#000000' }};" 
                                                             tabindex="0" role="button"></div>
                                                    </span>
                                                    <input type="text" class="form-input flex-1" id="outer_eye_color" name="outer_eye_color" 
                                                           value="{{ qr_code.outer_eye_color if qr_code.outer_eye_color else qr_code.color if qr_code.color else '#000000' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gradient & Effects -->
                                <div class="accordion-header p-4 flex items-center justify-between cursor-pointer" x-data="{open: {{ 'true' if qr_code.gradient else 'false' }}}" @click="open = !open">
                                    <h3 class="text-sm font-medium text-gray-700 flex items-center">
                                        <i class="fas fa-fill-drip text-gray-600 mr-2"></i> Gradient & Effects
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 text-sm transition-transform duration-200" :class="{'transform rotate-180': open}"></i>
                                </div>
                                <div x-show="open" x-transition class="p-4 border border-t-0 border-gray-200">
                                    <div class="mb-4">
                                        <label for="export_type" class="form-label block">Effect Type</label>
                                        <select class="form-input w-full" id="export_type" name="export_type">
                                            <option value="png" {{ 'selected' if not qr_code.gradient or qr_code.export_type == 'png' else '' }}>Solid Color</option>
                                            <option value="gradient" {{ 'selected' if qr_code.gradient or qr_code.export_type == 'gradient' else '' }}>Linear Gradient</option>
                                        </select>
                                    </div>
                                    
                                    <div id="gradient-options" class="{{ 'hidden' if not qr_code.gradient else '' }}">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="gradient_start_color" class="form-label block">Gradient Start Color</label>
                                                <div class="flex">
                                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 rounded-l">
                                                        <div id="gradient-start-preview" class="color-preview" 
                                                             style="background-color: {{ qr_code.gradient_start if qr_code.gradient_start else '#FF5500' }};" 
                                                             tabindex="0" role="button"></div>
                                                    </span>
                                                    <input type="text" class="form-input flex-1 rounded-l-none" id="gradient_start_color" name="gradient_start" 
                                                           value="{{ qr_code.gradient_start if qr_code.gradient_start else '#FF5500' }}">
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label for="gradient_end_color" class="form-label block">Gradient End Color</label>
                                                <div class="flex">
                                                    <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 rounded-l">
                                                        <div id="gradient-end-preview" class="color-preview" 
                                                             style="background-color: {{ qr_code.gradient_end if qr_code.gradient_end else '#FFAA00' }};" 
                                                             tabindex="0" role="button"></div>
                                                    </span>
                                                    <input type="text" class="form-input flex-1 rounded-l-none" id="gradient_end_color" name="gradient_end" 
                                                           value="{{ qr_code.gradient_end if qr_code.gradient_end else '#FFAA00' }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="gradient-preview mt-4 rounded" 
                                             style="background: linear-gradient(135deg, {{ qr_code.gradient_start if qr_code.gradient_start else '#FF5500' }}, {{ qr_code.gradient_end if qr_code.gradient_end else '#FFAA00' }}); height: 40px; border: 1px solid #e5e7eb;"></div>
                                    </div>
                                </div>
                                
                                <!-- Size & Error Correction -->
                                <div class="accordion-header p-4 flex items-center justify-between cursor-pointer" x-data="{open: false}" @click="open = !open">
                                    <h3 class="text-sm font-medium text-gray-700 flex items-center">
                                        <i class="fas fa-expand-arrows-alt text-gray-600 mr-2"></i> Size & Error Correction
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 text-sm transition-transform duration-200" :class="{'transform rotate-180': open}"></i>
                                </div>
                                <div x-show="open" x-transition class="p-4 border border-t-0 border-gray-200">
                                    <div class="mb-6">
                                        <label for="module_size" class="form-label block">
                                            Module Size: <span id="module-size-value" class="font-semibold">{{ qr_code.module_size if qr_code.module_size else 10 }}</span>px
                                        </label>
                                        <input type="range" class="w-full" id="module_size" name="module_size" min="4" max="20" 
                                               value="{{ qr_code.module_size if qr_code.module_size else 10 }}">
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label for="quiet_zone" class="form-label block">
                                            Quiet Zone: <span id="quiet-zone-value" class="font-semibold">{{ qr_code.quiet_zone if qr_code.quiet_zone else 4 }}</span> units
                                        </label>
                                        <input type="range" class="w-full" id="quiet_zone" name="quiet_zone" min="0" max="8" 
                                               value="{{ qr_code.quiet_zone if qr_code.quiet_zone else 4 }}">
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label for="error_correction" class="form-label block">Error Correction Level</label>
                                        <select class="form-input w-full" id="error_correction" name="error_correction">
                                            <option value="L" {{ 'selected' if qr_code.error_correction == 'L' else '' }}>Low (7%)</option>
                                            <option value="M" {{ 'selected' if qr_code.error_correction == 'M' else '' }}>Medium (15%)</option>
                                            <option value="Q" {{ 'selected' if qr_code.error_correction == 'Q' else '' }}>Quartile (25%)</option>
                                            <option value="H" {{ 'selected' if qr_code.error_correction == 'H' else 'selected' if not qr_code.error_correction else '' }}>High (30%)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Watermark -->
                                <div class="accordion-header p-4 flex items-center justify-between cursor-pointer" x-data="{open: {{ 'true' if qr_code.watermark_text else 'false' }}}" @click="open = !open">
                                    <h3 class="text-sm font-medium text-gray-700 flex items-center">
                                        <i class="fas fa-signature text-gray-600 mr-2"></i> Watermark
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 text-sm transition-transform duration-200" :class="{'transform rotate-180': open}"></i>
                                </div>
                                <div x-show="open" x-transition class="p-4 border border-t-0 border-gray-200">
                                    <div class="mb-4">
                                        <label for="watermark_text" class="form-label block">Watermark Text</label>
                                        <input type="text" class="form-input w-full" id="watermark_text" name="watermark_text" 
                                               value="{{ qr_code.watermark_text if qr_code.watermark_text else '' }}" 
                                               placeholder="Created with QR Craft">
                                        <p class="help-text mt-1">Adds subtle text to the bottom of the QR code</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Update Actions -->
                <div class="formal-card p-6">
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 formal-button py-3 px-4 font-medium flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Update QR Code
                        </button>
                        <a href="{{ url_for('view_qr', qr_id=qr_code.unique_id) }}" 
                           class="formal-button-secondary py-3 px-4 font-medium flex items-center justify-center">
                            <i class="fas fa-times mr-2"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="xl:col-span-1">
                <!-- Live Preview -->
                <div class="formal-card p-6 sticky top-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Live Preview</h3>
                    <div class="current-qr-display">
                        <img src="/static/images/qr-placeholder.png" alt="QR Code Preview" class="w-full h-auto" id="qr-preview-image">
                    </div>
                    <p class="text-sm text-gray-600 my-3 text-center">
                        <i class="fas fa-info-circle mr-1"></i> 
                        Changes will update automatically
                    </p>
                    
                    <div class="mt-6 space-y-3">
                        <button type="button" class="w-full py-2 px-4 border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none text-sm font-medium" id="refreshPreviewBtn">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh Preview
                        </button>
                        
                        <button type="button" class="w-full py-2 px-4 border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none text-sm font-medium" id="downloadPreviewBtn">
                            <i class="fas fa-download mr-2"></i> Download Preview
                        </button>
                    </div>
                </div>

                <!-- Recent Scan Analytics -->
                {% if scans and scans|length > 0 %}
                <div class="formal-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Scans</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for scan in scans[:10] %}
                            <div class="scan-item p-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-800">
                                            {{ scan.timestamp.strftime('%b %d, %Y') }}
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            {{ scan.timestamp.strftime('%I:%M %p') }}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% if scan.location %}
                                            <div class="text-sm text-gray-600">
                                                <i class="fas fa-map-marker-alt mr-1"></i>
                                                {{ scan.location[:20] }}...
                                            </div>
                                        {% endif %}
                                        {% if scan.user_agent %}
                                            <div class="text-xs text-gray-500">
                                                {% if 'Mobile' in scan.user_agent %}
                                                    <i class="fas fa-mobile-alt mr-1"></i> Mobile
                                                {% else %}
                                                    <i class="fas fa-desktop mr-1"></i> Desktop
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if scans|length > 10 %}
                        <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                            <a href="{{ url_for('view_qr', qr_id=qr_code.unique_id) }}" 
                               class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                View All {{ scans|length }} Scans
                            </a>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    // Global variables to track form state for edit mode
    let currentQRType = '{{ qr_code.qr_type }}';
    let formChanged = false;
    let changeHistory = [];

    // Configuration for toast notifications
    toastr.options = {
        closeButton: true,
        newestOnTop: true,
        progressBar: true,
        positionClass: "toast-bottom-right",
        preventDuplicates: false,
        showDuration: "300",
        hideDuration: "1000",
        timeOut: "5000",
        extendedTimeOut: "1000",
        showEasing: "swing",
        hideEasing: "linear",
        showMethod: "fadeIn",
        hideMethod: "fadeOut"
    };

    function updateQRPreview(reason = null) {
        const previewContainer = document.querySelector('.current-qr-display');
        const previewImage = document.getElementById('qr-preview-image');
        
        // Create or update loading overlay
        let loadingOverlay = document.querySelector('.preview-loading');
        if (!loadingOverlay) {
            loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'preview-loading absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center rounded-lg';
            loadingOverlay.innerHTML = `
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm font-medium text-gray-700">Updating preview...</p>`;
            previewContainer.style.position = 'relative';
            previewContainer.appendChild(loadingOverlay);
        } else {
            loadingOverlay.style.display = 'flex';
        }
        
        // Build form data from current values
        const form = document.getElementById('edit-qr-form');
        const formData = new FormData(form);

        // Ensure all color values are included and properly formatted
        const colorFields = ['color', 'background_color', 'inner_eye_color', 'outer_eye_color', 'gradient_start', 'gradient_end'];
        colorFields.forEach(fieldId => {
            const input = document.getElementById(fieldId);
            if (input && input.value) {
                let colorValue = formatColorValue(input.value);
                formData.set(fieldId, colorValue);
            }
        });

        // Handle logo file properly
        const logoInput = document.getElementById('logo');
        if (logoInput && logoInput.files && logoInput.files[0]) {
            formData.set('logo', logoInput.files[0]);
            
            const logoSizeSlider = document.getElementById('logo_size_percentage');
            const roundLogoCheckbox = document.getElementById('round_logo');
            
            if (logoSizeSlider) {
                formData.set('logo_size_percentage', logoSizeSlider.value);
            }
            if (roundLogoCheckbox) {
                formData.set('round_logo', roundLogoCheckbox.checked ? 'true' : 'false');
            }
        }

        // Ensure custom eyes options are included
        const customEyesCheckbox = document.getElementById('custom_eyes');
        if (customEyesCheckbox) {
            formData.set('custom_eyes', customEyesCheckbox.checked ? 'true' : 'false');
            if (customEyesCheckbox.checked) {
                formData.set('using_custom_eyes', 'true');
            }
        }

        // Handle gradient colors if in gradient mode
        const exportType = document.getElementById('export_type');
        if (exportType && exportType.value === 'gradient') {
            const gradientStart = document.getElementById('gradient_start_color');
            const gradientEnd = document.getElementById('gradient_end_color');
            if (gradientStart && gradientStart.value) {
                formData.set('gradient_start', formatColorValue(gradientStart.value));
            }
            if (gradientEnd && gradientEnd.value) {
                formData.set('gradient_end', formatColorValue(gradientEnd.value));
            }
            formData.set('using_gradient', 'true');
        } else {
            formData.set('export_type', 'png');
            formData.set('using_gradient', 'false');
        }
        
        // Make AJAX request to preview endpoint
        fetch('/preview-qr', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Preview request failed with status: ${response.status}`);
            }
            return response.blob();
        })
        .then(blob => {
            // Hide loading overlay
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            // Update preview image
            const url = URL.createObjectURL(blob);
            previewImage.src = url;
            
            // Add to change history if reason is provided
            if (reason) {
                addToChangeHistory(reason);
            }
            
            return true;
        })
        .catch(error => {
            console.error('Error updating preview:', error);
            
            // Hide loading overlay
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            toastr.error(
                'Could not generate preview. Try different settings or refresh the page.', 
                'Preview Error'
            );
        });
    }

    // Enhanced formatColorValue function with better hex color validation
    function formatColorValue(color) {
        if (!color) return '#000000';
        
        color = String(color).trim();
        color = color.replace(/\s/g, '');
        
        if (!color.startsWith('#')) {
            color = '#' + color;
        }
        
        if (/^#[0-9A-Fa-f]{3}$/.test(color)) {
            color = '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
        }
        
        if (!/^#[0-9A-Fa-f]{6}$/.test(color)) {
            console.warn('Invalid color format:', color);
            return '#000000';
        }
        
        return color.toUpperCase();
    }

    // Add to change history
    function addToChangeHistory(changeText) {
        const timestamp = new Date();
        const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        changeHistory.unshift({
            text: changeText,
            time: timeString,
            timestamp: timestamp
        });
        
        if (changeHistory.length > 10) {
            changeHistory.pop();
        }
        
        updateChangeHistoryUI();
    }

    // Update change history UI
    function updateChangeHistoryUI() {
        // For edit mode, we can show changes in console or a dedicated area if needed
        console.log('Change History:', changeHistory);
    }

    // Setup form change detection for edit mode
    function setupFormChangeDetection() {
        const form = document.getElementById('edit-qr-form');
        const inputs = form.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.addEventListener('change', function() {
                    let changeText = '';
                    
                    if (input.type === 'checkbox') {
                        changeText = `${this.checked ? 'Enabled' : 'Disabled'} ${getInputLabel(this)}`;
                    } else if (input.type === 'radio') {
                        if (input.name === 'shape') {
                            changeText = `Changed shape to ${getInputLabel(this)}`;
                        } else if (input.name === 'frame_type') {
                            changeText = input.value ? 
                                `Added ${getInputLabel(this)} frame` : 
                                'Removed frame';
                        } else if (input.name === 'template') {
                            const templateCard = document.querySelector(`.template-card[data-template="${input.value}"]`);
                            if (templateCard) {
                                const templateName = templateCard.querySelector('h3').textContent;
                                changeText = `Applied '${templateName}' template`;
                            }
                        }
                    }
                    
                    debounce(() => updateQRPreview(changeText), 500)();
                    formChanged = true;
                });
            } else {
                input.addEventListener('input', debounce(function() {
                    if (input.name.includes('color')) return;
                    
                    let changeText = getChangeText(input);
                    updateQRPreview(changeText);
                    formChanged = true;
                }, 800));
            }
        });
        
        setupLogoHandling();
    }

    function getInputLabel(input) {
        const label = input.labels ? input.labels[0] : null;
        if (label) {
            const span = label.querySelector('span');
            return span ? span.textContent.trim() : label.textContent.trim();
        }
        return input.name;
    }

    function getChangeText(input) {
        const fieldName = input.name;
        const labelText = getInputLabel(input);
        
        switch(fieldName) {
            case 'name': return 'Updated QR code name';
            case 'url': return 'Updated URL';
            case 'text': return 'Updated text content';
            case 'phone': return 'Updated phone number';
            case 'message': return 'Updated message text';
            case 'ssid': return 'Updated WiFi network name';
            case 'password': return 'Updated password';
            case 'module_size': return `Adjusted module size to ${input.value}px`;
            case 'quiet_zone': return `Set quiet zone to ${input.value} units`;
            case 'watermark_text': return input.value ? 'Added watermark text' : 'Removed watermark';
            case 'logo_size_percentage': return `Adjusted logo size to ${input.value}%`;
            case 'frame_text': return 'Updated frame text';
            default: return `Updated ${labelText}`;
        }
    }

    // Setup logo input handling for edit mode
    function setupLogoHandling() {
        const logoInput = document.getElementById('logo');
        const removeLogoBtn = document.getElementById('removeLogo');
        const removeCurrentLogoBtn = document.getElementById('removeCurrentLogo');
        
        if (logoInput) {
            logoInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const fileName = this.files[0].name;
                    
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(this.files[0].type)) {
                        toastr.error('Please upload a JPEG, PNG, or GIF image.', 'Invalid File Type');
                        this.value = '';
                        return;
                    }
                    
                    updateQRPreview(`Updated logo: ${fileName}`);
                    toastr.success(`Logo updated successfully: ${fileName}`, 'Logo Updated');
                }
            });
        }
        
        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', function() {
                if (logoInput) {
                    logoInput.value = '';
                    updateQRPreview('Removed new logo selection');
                    toastr.info('New logo selection removed', 'Logo Removed');
                }
            });
        }
        
        if (removeCurrentLogoBtn) {
            removeCurrentLogoBtn.addEventListener('click', function() {
                // Add hidden field to indicate logo removal
                let removeLogoField = document.getElementById('remove_logo');
                if (!removeLogoField) {
                    removeLogoField = document.createElement('input');
                    removeLogoField.type = 'hidden';
                    removeLogoField.id = 'remove_logo';
                    removeLogoField.name = 'remove_logo';
                    removeLogoField.value = 'true';
                    document.getElementById('edit-qr-form').appendChild(removeLogoField);
                } else {
                    removeLogoField.value = 'true';
                }
                
                // Hide the current logo display
                this.closest('.bg-blue-50').style.display = 'none';
                updateQRPreview('Removed current logo');
                toastr.info('Current logo will be removed when you save', 'Logo Marked for Removal');
            });
        }
    }

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(context, args);
            }, wait);
        };
    }

    // Setup QR type switching for edit mode (read-only display)
    function setupQRTypeSwitching() {
        const qrTypeBtns = document.querySelectorAll('.qr-type-option');
        
        // In edit mode, QR type options are for display only
        qrTypeBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                // Show info that type cannot be changed in edit mode
                toastr.info('QR code type cannot be changed after creation. Create a new QR code for different types.', 'Type Locked');
            });
        });
    }

    // Setup template selection for edit mode
    function setupTemplateSelection() {
        const templateCards = document.querySelectorAll('.template-card');
        
        templateCards.forEach(card => {
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
            
            card.addEventListener('click', function() {
                templateCards.forEach(c => {
                    c.classList.remove('selected');
                    c.setAttribute('aria-pressed', 'false');
                });
                
                this.classList.add('selected');
                this.setAttribute('aria-pressed', 'true');
                
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                
                const templateName = this.querySelector('h3').textContent;
                
                if (this.dataset.template === 'custom') {
                    document.getElementById('custom-tab').click();
                    toastr.info('Switched to custom design mode', 'Custom Template');
                } else {
                    toastr.success(`'${templateName}' template applied`, 'Template Changed');
                    enhancedApplyTemplateStyles(this.dataset.template);
                }
                
                updateQRPreview(`Applied '${templateName}' template`);
            });
        });
    }

    // Setup tab switching
    function setupTabSwitching() {
        const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const target = document.querySelector(this.dataset.bsTarget);
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                
                tabPanes.forEach(pane => {
                    pane.classList.remove('show', 'active');
                    pane.classList.add('hidden');
                });
                
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                
                target.classList.remove('hidden');
                target.classList.add('show', 'active');
            });
        });
    }

    // Initialize color pickers for edit mode
    function setupColorPickers() {
        const inputs = document.querySelectorAll('input[id$="color"]');
        
        inputs.forEach(input => {
            const flex = input.closest('.flex');
            if (!flex) return;

            const preview = flex.querySelector('.color-preview');
            if (!preview) return;

            // Set initial color from existing value
            preview.style.backgroundColor = formatColorValue(input.value);

            const popupId = `color-popup-${input.id}`;
            let popup = document.getElementById(popupId);

            if (!popup) {
                popup = document.createElement('div');
                popup.id = popupId;
                popup.className = 'color-picker-popup hidden absolute z-50 mt-2 p-2';
                popup.innerHTML = `
                    <div class="grid grid-cols-6 gap-2">
                        ${['#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF','#FFA500','#800080','#008000','#800000']
                            .map(color => `<div class="color-preset w-6 h-6 cursor-pointer rounded border border-gray-300 hover:border-gray-500" style="background-color: ${color}" data-color="${color}"></div>`).join('')}
                    </div>
                    <input type="color" class="mt-2 w-full h-8 rounded border border-gray-300" value="${formatColorValue(input.value)}">
                `;
                flex.appendChild(popup);

                // Color preset click handlers
                popup.querySelectorAll('.color-preset').forEach(preset => {
                    preset.addEventListener('click', function () {
                        const color = this.dataset.color;
                        updateColorInputWithPreview(input, preview, color);
                        popup.classList.add('hidden');
                    });
                });

                // Native color picker handler
                popup.querySelector('input[type="color"]').addEventListener('input', function () {
                    updateColorInputWithPreview(input, preview, this.value);
                });

                // Color picker change handler (when user finishes selecting)
                popup.querySelector('input[type="color"]').addEventListener('change', function () {
                    updateColorInputWithPreview(input, preview, this.value);
                });
            }

            // Preview click handler
            preview.addEventListener('click', function (e) {
                e.stopPropagation();
                document.querySelectorAll('.color-picker-popup').forEach(p => {
                    if (p !== popup) p.classList.add('hidden');
                });
                popup.classList.toggle('hidden');
                popup.querySelector('input[type="color"]').value = formatColorValue(input.value);
            });

            // Direct input field handlers
            input.addEventListener('input', debounce(function() {
                updateColorInputWithPreview(input, preview, this.value);
            }, 300));

            input.addEventListener('change', function() {
                updateColorInputWithPreview(input, preview, this.value);
            });

            input.addEventListener('paste', function () {
                setTimeout(() => {
                    updateColorInputWithPreview(input, preview, this.value);
                }, 50);
            });
        });

        // Close color pickers when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.color-picker-popup').forEach(popup => popup.classList.add('hidden'));
        });
    }

    function updateColorInputWithPreview(input, preview, color) {
        const formattedColor = formatColorValue(color);
        input.value = formattedColor;
        preview.style.backgroundColor = formattedColor;
        input.dataset.userChanged = 'true';
        
        // Update gradient preview if this is a gradient color
        if (input.id.includes('gradient')) {
            updateGradientPreview();
        }
        
        // Generate appropriate change text
        let changeText = '';
        switch(input.id) {
            case 'color':
                changeText = `Changed QR code color to ${formattedColor}`;
                break;
            case 'background_color':
                changeText = `Changed background color to ${formattedColor}`;
                break;
            case 'inner_eye_color':
                changeText = `Changed inner eye color to ${formattedColor}`;
                break;
            case 'outer_eye_color':
                changeText = `Changed outer eye color to ${formattedColor}`;
                break;
            case 'gradient_start_color':
                changeText = `Updated gradient start color to ${formattedColor}`;
                break;
            case 'gradient_end_color':
                changeText = `Updated gradient end color to ${formattedColor}`;
                break;
            default:
                changeText = `Updated color to ${formattedColor}`;
        }
        
        // Trigger preview update with debounce for better performance
        debounce(() => {
            updateQRPreview(changeText);
        }, 500)();
    }

    // Legacy function for compatibility
    function updateColorInput(input, preview, color) {
        updateColorInputWithPreview(input, preview, color);
    }

    function updateGradientPreview() {
        const startColor = document.getElementById('gradient_start_color');
        const endColor = document.getElementById('gradient_end_color');
        const gradientPreview = document.querySelector('.gradient-preview');
        
        if (gradientPreview && startColor && endColor) {
            gradientPreview.style.background = `linear-gradient(135deg, ${startColor.value}, ${endColor.value})`;
        }
    }

    // Setup eye customization
    function setupEyeCustomization() {
        const customEyesCheckbox = document.getElementById('custom_eyes');
        const eyeCustomizationOptions = document.getElementById('eye-customization-options');
        
        if (customEyesCheckbox && eyeCustomizationOptions) {
            eyeCustomizationOptions.classList.toggle('hidden', !customEyesCheckbox.checked);
            
            let customEyesField = document.getElementById('using_custom_eyes');
            if (!customEyesField) {
                customEyesField = document.createElement('input');
                customEyesField.type = 'hidden';
                customEyesField.id = 'using_custom_eyes';
                customEyesField.name = 'using_custom_eyes';
                customEyesCheckbox.parentNode.appendChild(customEyesField);
            }
            customEyesField.value = customEyesCheckbox.checked ? 'true' : 'false';
            
            customEyesCheckbox.addEventListener('change', function() {
                eyeCustomizationOptions.classList.toggle('hidden', !this.checked);
                customEyesField.value = this.checked ? 'true' : 'false';
                
                if (this.checked) {
                    const mainColor = document.getElementById('color').value;
                    const innerEyeColorInput = document.getElementById('inner_eye_color');
                    const outerEyeColorInput = document.getElementById('outer_eye_color');
                    
                    if (innerEyeColorInput && (!innerEyeColorInput.value || innerEyeColorInput.value === '#000000')) {
                        innerEyeColorInput.value = mainColor;
                        const innerPreview = document.getElementById('inner-eye-color-preview');
                        if (innerPreview) innerPreview.style.backgroundColor = mainColor;
                    }
                    
                    if (outerEyeColorInput && (!outerEyeColorInput.value || outerEyeColorInput.value === '#000000')) {
                        outerEyeColorInput.value = mainColor;
                        const outerPreview = document.getElementById('outer-eye-color-preview');
                        if (outerPreview) outerPreview.style.backgroundColor = mainColor;
                    }
                }
                
                updateQRPreview('Toggled custom eye styles');
            });
        }
    }

    // Setup gradient options
    function setupGradientOptions() {
        const exportTypeSelect = document.getElementById('export_type');
        const gradientOptions = document.getElementById('gradient-options');
        
        if (exportTypeSelect && gradientOptions) {
            // Set initial state based on existing QR code
            const isCurrentlyGradient = '{{ "true" if qr_code.gradient else "false" }}' === 'true';
            exportTypeSelect.value = isCurrentlyGradient ? 'gradient' : 'png';
            gradientOptions.classList.toggle('hidden', !isCurrentlyGradient);
            
            let gradientField = document.getElementById('using_gradient');
            if (!gradientField) {
                gradientField = document.createElement('input');
                gradientField.type = 'hidden';
                gradientField.id = 'using_gradient';
                gradientField.name = 'using_gradient';
                exportTypeSelect.parentNode.appendChild(gradientField);
            }
            gradientField.value = isCurrentlyGradient ? 'true' : 'false';
            
            exportTypeSelect.addEventListener('change', function() {
                const isGradient = this.value === 'gradient';
                gradientOptions.classList.toggle('hidden', !isGradient);
                gradientField.value = isGradient ? 'true' : 'false';
                
                if (isGradient) {
                    const mainColor = document.getElementById('color').value;
                    const gradientStartInput = document.getElementById('gradient_start_color');
                    const gradientEndInput = document.getElementById('gradient_end_color');
                    
                    if (gradientStartInput && (!gradientStartInput.value || gradientStartInput.value === '#000000')) {
                        gradientStartInput.value = mainColor;
                        const startPreview = document.getElementById('gradient-start-preview');
                        if (startPreview) startPreview.style.backgroundColor = mainColor;
                    }
                    
                    if (gradientEndInput && (!gradientEndInput.value || gradientEndInput.value === '#000000')) {
                        const endColor = lightenColor(mainColor, 30);
                        gradientEndInput.value = endColor;
                        const endPreview = document.getElementById('gradient-end-preview');
                        if (endPreview) endPreview.style.backgroundColor = endColor;
                    }
                    
                    updateGradientPreview();
                }
                
                updateQRPreview('Changed to ' + this.options[this.selectedIndex].text);
            });
            
            // Update gradient preview on color changes
            const gradientStartInput = document.getElementById('gradient_start_color');
            const gradientEndInput = document.getElementById('gradient_end_color');
            
            if (gradientStartInput && gradientEndInput) {
                gradientStartInput.addEventListener('input', updateGradientPreview);
                gradientEndInput.addEventListener('input', updateGradientPreview);
            }
        }
    }

    // Helper function to lighten color
    function lightenColor(hex, percent) {
        hex = hex.replace(/^\s*#|\s*$/g, '');
        
        if(hex.length == 3){
            hex = hex.replace(/(.)/g, '$1$1');
        }
        
        var r = parseInt(hex.substr(0, 2), 16),
            g = parseInt(hex.substr(2, 2), 16),
            b = parseInt(hex.substr(4, 2), 16);
        
        r = Math.min(255, Math.round(r + (255 - r) * (percent / 100)));
        g = Math.min(255, Math.round(g + (255 - g) * (percent / 100)));
        b = Math.min(255, Math.round(b + (255 - b) * (percent / 100)));
        
        return '#' + 
            (r.toString(16).padStart(2, '0')) +
            (g.toString(16).padStart(2, '0')) +
            (b.toString(16).padStart(2, '0'));
    }

    // Setup sliders to update their displayed values
    function setupSliders() {
        const sliders = [
            { slider: 'module_size', display: 'module-size-value' },
            { slider: 'quiet_zone', display: 'quiet-zone-value' },
            { slider: 'logo_size_percentage', display: 'logo-size-value' }
        ];
        
        sliders.forEach(({ slider, display }) => {
            const sliderEl = document.getElementById(slider);
            const displayEl = document.getElementById(display);
            
            if (sliderEl && displayEl) {
                displayEl.textContent = sliderEl.value;
                sliderEl.addEventListener('input', function() {
                    displayEl.textContent = this.value;
                });
            }
        });
    }

    // Setup frame text visibility
    function setupFrameText() {
        const frameTypeRadios = document.querySelectorAll('input[name="frame_type"]');
        const frameTextContainer = document.getElementById('frame-text-container');
        
        if (frameTypeRadios.length && frameTextContainer) {
            const selectedFrameType = document.querySelector('input[name="frame_type"]:checked');
            const needsText = selectedFrameType && ['scan_me', 'branded'].includes(selectedFrameType.value);
            frameTextContainer.classList.toggle('hidden', !needsText);
            
            frameTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const needsText = ['scan_me', 'branded'].includes(this.value);
                    frameTextContainer.classList.toggle('hidden', !needsText);
                });
            });
        }
    }

    // Setup password toggle for WiFi
    function setupPasswordToggle() {
        const togglePasswordBtn = document.getElementById('toggleWifiPassword');
        const passwordInput = document.getElementById('wifi-password');
        
        if (togglePasswordBtn && passwordInput) {
            togglePasswordBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                const icon = this.querySelector('i');
                if (type === 'password') {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                } else {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
            });
        }
    }

    // Setup form validation for edit mode
    function setupFormValidation() {
        const form = document.getElementById('edit-qr-form');
        
        form.classList.add('needs-validation');
        
        form.addEventListener('submit', function(event) {
            // Validate color inputs before submission
            const colorInputs = form.querySelectorAll('input[id$="color"]');
            let hasColorError = false;
            
            colorInputs.forEach(input => {
                if (input && input.value) {
                    let colorValue = input.value.trim();
                    if (!colorValue.startsWith('#')) {
                        colorValue = '#' + colorValue;
                    }
                    
                    if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(colorValue)) {
                        event.preventDefault();
                        event.stopPropagation();
                        hasColorError = true;
                        
                        const label = input.labels ? input.labels[0] : null;
                        const fieldName = label ? label.textContent.trim() : (input.name || input.id);
                        
                        toastr.error(
                            `Invalid color format for ${fieldName}. Please use a valid hex color (e.g., #000000).`,
                            'Validation Error'
                        );
                        
                        input.focus();
                    }
                    
                    input.value = colorValue;
                }
            });

            if (hasColorError) {
                return false;
            }
            
            // Check for any hidden required fields and temporarily make them not required
            const hiddenFields = form.querySelectorAll('.hidden [required]');
            hiddenFields.forEach(field => {
                field.setAttribute('data-was-required', 'true');
                field.removeAttribute('required');
            });
            
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                const invalidFields = form.querySelectorAll(':invalid');
                
                const missingFieldsList = Array.from(invalidFields).map(field => {
                    const label = field.labels ? field.labels[0] : null;
                    const fieldName = label ? label.textContent.trim() : (field.name || field.id);
                    return fieldName.replace(' *', '');
                });
                
                if (missingFieldsList.length > 0) {
                    const errorMsg = `Please fill in the following required fields: ${missingFieldsList.join(', ')}`;
                    toastr.error(errorMsg, 'Validation Error');
                    
                    invalidFields[0].focus();
                    invalidFields[0].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                } else {
                    toastr.error('Please fill in all required fields correctly', 'Validation Error');
                }
            } else {
                // Add gradient flag if needed
                const exportType = document.getElementById('export_type');
                if (exportType && exportType.value === 'gradient') {
                    let gradientField = document.getElementById('using_gradient');
                    if (!gradientField) {
                        gradientField = document.createElement('input');
                        gradientField.type = 'hidden';
                        gradientField.id = 'using_gradient';
                        gradientField.name = 'using_gradient';
                        form.appendChild(gradientField);
                    }
                    gradientField.value = 'true';
                }
                
                // Add custom eyes flag if needed
                const customEyes = document.getElementById('custom_eyes');
                if (customEyes && customEyes.checked) {
                    let customEyesField = document.getElementById('using_custom_eyes');
                    if (!customEyesField) {
                        customEyesField = document.createElement('input');
                        customEyesField.type = 'hidden';
                        customEyesField.id = 'using_custom_eyes';
                        customEyesField.name = 'using_custom_eyes';
                        form.appendChild(customEyesField);
                    }
                    customEyesField.value = 'true';
                }
                
                // Update submit button
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = `
                        <div class="animate-spin -ml-1 mr-3 h-5 w-5 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        Updating QR Code...`;
                    submitBtn.disabled = true;
                }
                
                formChanged = false;
            }
            
            // Restore required attribute to fields
            hiddenFields.forEach(field => {
                if (field.getAttribute('data-was-required') === 'true') {
                    field.setAttribute('required', '');
                    field.removeAttribute('data-was-required');
                }
            });
            
            form.classList.add('was-validated');
        });
    }

    // Apply template styles (enhanced version)
    function enhancedApplyTemplateStyles(template) {
        if (!template) return;
        
        const templates = {
            modern: {
                shape: "rounded",
                color: "#2c5282",
                background_color: "#FFFFFF",
                export_type: "png",
                custom_eyes: true,
                inner_eye_style: "circle",
                outer_eye_style: "rounded",
                inner_eye_color: "#2c5282",
                outer_eye_color: "#2c5282"
            },
            corporate: {
                shape: "square",
                color: "#1a365d",
                background_color: "#FFFFFF",
                export_type: "png",
                frame_type: "square",
                frame_color: "#1a365d",
                custom_eyes: false
            },
            playful: {
                shape: "circle",
                export_type: "gradient",
                gradient_start: "#3182ce",
                gradient_end: "#90cdf4",
                background_color: "#FFFFFF",
                custom_eyes: true,
                inner_eye_style: "circle",
                outer_eye_style: "circle",
                inner_eye_color: "#3182ce",
                outer_eye_color: "#3182ce"
            },
            minimal: {
                shape: "square",
                color: "#2d3748",
                background_color: "#FFFFFF",
                export_type: "png",
                custom_eyes: false
            },
            high_contrast: {
                shape: "square",
                color: "#000000",
                background_color: "#FFFFFF",
                export_type: "png",
                module_size: 12,
                quiet_zone: 4,
                custom_eyes: false
            }
        };
        
        const styles = templates[template];
        if (!styles) return;
        
        // Reset user-changed flags when applying template
        document.querySelectorAll('input[id$="color"]').forEach(input => {
            input.dataset.userChanged = 'false';
        });
        
        // Apply template styles
        Object.keys(styles).forEach(key => {
            const value = styles[key];
            const element = document.getElementById(key);
            
            if (element) {
                if (key.includes('color')) {
                    if (element.dataset.userChanged !== 'true') {
                        const formattedColor = formatColorValue(value);
                        element.value = formattedColor;
                        
                        const preview = document.getElementById(`${key}-preview`);
                        if (preview) {
                            preview.style.backgroundColor = formattedColor;
                        }
                    }
                } else if (element.type === 'checkbox') {
                    element.checked = value;
                    
                    if (key === 'custom_eyes') {
                        const eyeOptions = document.getElementById('eye-customization-options');
                        if (eyeOptions) {
                            eyeOptions.classList.toggle('hidden', !value);
                        }
                        
                        const hiddenField = document.getElementById('using_custom_eyes');
                        if (hiddenField) {
                            hiddenField.value = value ? 'true' : 'false';
                        }
                    }
                } else if (element.tagName === 'SELECT') {
                    element.value = value;
                    
                    if (key === 'export_type') {
                        const gradientOptions = document.getElementById('gradient-options');
                        if (gradientOptions) {
                            const isGradient = value === 'gradient';
                            gradientOptions.classList.toggle('hidden', !isGradient);
                            
                            if (isGradient) {
                                const customEyesCheckbox = document.getElementById('custom_eyes');
                                if (customEyesCheckbox) {
                                    customEyesCheckbox.checked = true;
                                    customEyesCheckbox.disabled = true;
                                    
                                    const eyeOptions = document.getElementById('eye-customization-options');
                                    if (eyeOptions) {
                                        eyeOptions.classList.remove('hidden');
                                    }
                                }
                            }
                        }
                        
                        const gradientField = document.getElementById('using_gradient');
                        if (gradientField) {
                            gradientField.value = value === 'gradient' ? 'true' : 'false';
                        }
                    }
                } else if (element.type === 'text' || element.type === 'number' || element.type === 'range') {
                    element.value = value;
                    
                    if (element.type === 'range') {
                        const valueDisplay = document.getElementById(`${key}-value`);
                        if (valueDisplay) {
                            valueDisplay.textContent = value;
                        }
                    }
                }
            }
            
            // Handle radio button groups
            if (key === 'shape') {
                const radio = document.getElementById(`shape-${value}`);
                if (radio) {
                    radio.checked = true;
                }
            } else if (key === 'frame_type') {
                const radio = document.getElementById(`frame-${value}`);
                if (radio) {
                    radio.checked = true;
                    
                    const frameTextContainer = document.getElementById('frame-text-container');
                    if (frameTextContainer) {
                        frameTextContainer.classList.toggle('hidden', !['scan_me', 'branded'].includes(value));
                    }
                }
            }
        });
        
        if (styles.export_type === 'gradient') {
            updateGradientPreview();
        }
        
        updateQRPreview(`Applied '${template}' template`);
    }

    // Initialize edit form
    function initializeEditForm() {
        // Set initial color previews
        document.querySelectorAll('input[id$="color"]').forEach(input => {
            const preview = document.getElementById(`${input.id}-preview`);
            if (preview) {
                preview.style.backgroundColor = formatColorValue(input.value);
            }
        });
        
        // Set initial slider values
        setupSliders();
        
        // Show appropriate content section
        const currentType = '{{ qr_code.qr_type }}';
        document.querySelectorAll('.qr-type-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        const currentContent = document.getElementById(`${currentType}-content`);
        if (currentContent) {
            currentContent.classList.remove('hidden');
        }
        
        // Initialize gradient preview if gradient is enabled
        if ('{{ "true" if qr_code.gradient else "false" }}' === 'true') {
            updateGradientPreview();
        }
    }

    // Main initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize form with existing values
        initializeEditForm();
        
        // Setup all functionality
        setupQRTypeSwitching();
        setupTemplateSelection();
        setupTabSwitching();
        setupColorPickers();
        setupEyeCustomization();
        setupGradientOptions();
        setupFrameText();
        setupPasswordToggle();
        setupFormValidation();
        setupFormChangeDetection();
        
        // Setup preview buttons
        const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
        if (refreshPreviewBtn) {
            refreshPreviewBtn.addEventListener('click', function() {
                updateQRPreview('Manually refreshed preview');
                toastr.info('QR code preview refreshed', 'Preview Updated');
            });
        }
        
        const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
        if (downloadPreviewBtn) {
            downloadPreviewBtn.addEventListener('click', function() {
                const previewImage = document.getElementById('qr-preview-image');
                if (!previewImage || previewImage.src.includes('placeholder')) {
                    toastr.warning('Please generate a QR code first', 'Cannot Download');
                    return;
                }
                
                const link = document.createElement('a');
                link.href = previewImage.src;
                link.download = `qr-preview-edit-${new Date().getTime()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                toastr.success('QR code preview downloaded', 'Download Complete');
            });
        }
        
        // Initial preview after form initialization
        setTimeout(() => {
            updateQRPreview();
        }, 1000);
    });
</script>
{% endblock %}